---
title: "Peekbank DDM"
author: "Mike"
date: "2/23/2021"
output: html_document
---

# Preliminaries and data loading

```{r}
library(peekbankr)
library(tidyverse)
library(lme4)
library(lmerTest)
library(tictoc)
library(langcog)
library(here)

t_range <- c(-1000,3000)
knitr::opts_chunk$set(cache = TRUE, warn = FALSE, message = FALSE)

load(file = "data/aoi_data_joined.Rds")

```

# Reaction time analysis

```{r}
SAMPLING_RATE <- 40

rt_data <- aoi_data_joined %>%
  group_by(administration_id, trial_id) %>%
  filter(!all(aoi == "missing"), # can't be all missing
         t_norm >= 0, # data after 0
         any(t_norm == 0)) %>% # must have a zero point
  filter(aoi[t_norm == 0] %in% c("target","distractor")) # must have a D/T at 0. 

rts <- rt_data %>%
  summarise(lengths = rle(aoi)$lengths, 
            values = rle(aoi)$values) %>%
  group_by(administration_id, trial_id) %>%
  summarise(onset_aoi = values[1],
         first_landing = values[values != onset_aoi & values %in% c("target","distractor")][1], 
         shift_type = case_when(
           onset_aoi == "distractor" & first_landing == "target" ~ "D-T",
           onset_aoi == "target" & first_landing == "distractor" ~ "T-D",
           TRUE ~ "other"),
         rt = lengths[values == first_landing][1] * SAMPLING_RATE) %>%
  select(-onset_aoi, -first_landing) %>%
  filter(shift_type!="other")
```

Shift statistics. Why are there more D-T than T-D?  Looks like that's true across several datasets (perhaps some with novel words)? 

```{r}
ggplot(rts, aes(x = shift_type)) + 
  geom_histogram(stat = "count") + 
  facet_wrap(~dataset_name)
```

```{r}
rts <- left_join(rts, 
                 aoi_data_joined %>%
                   select(administration_id, trial_id, 
                          dataset_name, age, english_stimulus_label, 
                          stimulus_novelty, trial_order) %>% 
                   distinct()) %>%
  filter(stimulus_novelty == "familiar")
corr_rts <- filter(rts, shift_type == "D-T")

 # group_by(dataset_name) %>%
  # filter(rt_value < max(rt_value)-100, !is.na(rt_value)) # note sloppy exclusion of bad RTs (no shift trials)
```


Descriptive histograms. I'm a bit worried about these late bumps...

```{r}
ggplot(corr_rts, 
       aes(x = rt)) + 
  geom_histogram() + 
  facet_wrap(~dataset_name, scales = "free_y") 
```

Logs? This is cool as it suggests that the < 300 ms RTs really are junk. 

```{r}
ggplot(corr_rts, 
       aes(x = rt)) + 
  geom_histogram() + 
  scale_x_log10() + 
  facet_wrap(~dataset_name, scales = "free_y") 
```

So let's get rid of them. 

```{r}
rts <- filter(rts, rt > 300)
corr_rts <- filter(corr_rts, rt > 300)
```

RT by item? 

```{r}
rt_means <- rts %>%
  filter(age > 6, age < 66) %>%
  mutate(age_binned = cut(age, seq(6,66,12))) %>%
  group_by(administration_id, trial_id, english_stimulus_label, age_binned, shift_type) %>%
  summarise(sub_mean_rt = mean(rt)) %>%
  group_by(english_stimulus_label, age_binned, shift_type) %>%
  summarise(mean_rt = mean(sub_mean_rt), 
            sd_rt = sd(sub_mean_rt), 
            n = n(),
            ci = 1.96 * sd_rt / sqrt(n)) %>%
  filter(n > 10) %>%
  mutate(significant = (mean_rt - ci > .5 & mean_rt + ci > .5) |
           (mean_rt - ci < .5 & mean_rt + ci < .5)) %>%
  # group_by(age_binned) %>%
  mutate(sorted_stimulus_label = fct_reorder(as.factor(english_stimulus_label), 
                                             mean_rt, mean))

ggplot(rt_means, 
       aes(y = sorted_stimulus_label, x = mean_rt)) + 
  ggstance::geom_linerangeh(aes(xmin = mean_rt - ci, xmax = mean_rt + ci)) + 
  geom_point(aes(col = age_binned), size = 2) + 
  scale_shape_manual(values = c(1, 20)) + 
  geom_vline(xintercept = .5, lty = 2) + 
  facet_wrap(~shift_type) + 
  theme_mikabr()
```

Overall RT curve across age. 

```{r}
rt_subs <- corr_rts %>%
  filter(stimulus_novelty == "familiar", rt > 300, rt < 3000) %>%
  group_by(administration_id, trial_id, english_stimulus_label, age) %>%
  summarise(sub_mean_rt = mean(rt)) 


ggplot(rt_subs, 
       aes(x = age, y = sub_mean_rt)) + 
  geom_jitter(alpha = .03, width = .3, height = 0) +
  geom_smooth(method = "lm") + 
  scale_y_log10() +
  xlim(12,60) + 
  theme_mikabr() 
```

Summary RT curves across age

```{r}
rts %>%
  filter(age > 6, age < 66) %>%
  mutate(age_binned = cut(age, seq(6,66,12))) %>%
  group_by(age_binned) %>%
  ggplot(aes(x = age_binned, y = rt)) + 
  stat_summary(fun.data = "mean_cl_boot") +
  facet_wrap(~dataset_name)
```



Overall RT curve across trial order 

```{r}
rt_subs <- rts %>%
  filter(stimulus_novelty == "familiar", rt > 300, rt < 3000) %>%
  group_by(administration_id, trial_id, english_stimulus_label, dataset_name, 
           trial_order) %>%
  summarise(sub_mean_rt = mean(rt)) 


ggplot(rt_subs, 
       aes(x = trial_order, y = sub_mean_rt)) + 
  geom_point(alpha = .1) +
  geom_smooth(method = "lm") + 
  scale_y_log10() + 
  xlim(12,60) + 
  theme_mikabr() 
```


```{r}
rt_subs <- rts %>%
  filter(stimulus_novelty == "familiar", rt > 300, rt < 3000) %>%
  group_by(administration_id, trial_id, english_stimulus_label, age, dataset_name) %>%
  summarise(sub_mean_rt = mean(rt)) %>%
  group_by(english_stimulus_label) %>%
  filter(n() > 100) 

ggplot(rt_subs, 
       aes(x = age, y = sub_mean_rt, col = dataset_name)) + 
  geom_point(alpha = .1) +
  geom_smooth(method = "lm", formula = y ~ x) + 
  facet_wrap(~english_stimulus_label) + 
  ylim(0,4000) +
  theme_mikabr()
```


